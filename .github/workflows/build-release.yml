# .github/workflows/build-release.yml

name: Java CI - Build & Release Installer

# Esto dispara el workflow CADA VEZ que publicas una nueva "Release" en GitHub
on:
  release:
    types: [published] # Se activa cuando la "Release" es publicada

jobs:
  build-and-release:
    # Usamos el runner de Windows más reciente, ya que jpackage lo necesita para .msi
    runs-on: windows-latest

    steps:
      # 1. Obtenemos el código fuente del repositorio
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      # 2. Instalamos el JDK 24 (el que usas)
      - name: 2. Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin' # Una distribución de Java estándar

      # 3. Instalamos WiX Toolset v3 (requerido por jpackage en Windows)
      # Usamos Chocolatey, el gestor de paquetes de Windows
      - name: 3. Install WiX Toolset v3
        run: choco install wixtoolset --version 3.11.2 --no-progress
        shell: pwsh

      # 4. Construimos la aplicación con Gradle
      # -Pversion=${{ github.ref_name }} es la magia:
      # Pasa el nombre de la "Tag" de la Release (ej. "v0.1.0")
      # a la variable 'version' de tu build.gradle.
      - name: 4. Build with Gradle (using Release Tag as version)
        run: .\\gradlew.bat jpackage -Pversion=${{ github.ref_name }}

      # 5. Subimos el .msi generado a la "Release" de GitHub
      - name: 5. Upload Release Asset (.msi)
        uses: svenstaro/upload-release-asset@v2
        with:
          # Token de autenticación automático de GitHub
          repo_token: ${{ secrets.GITHUB_TOKEN }}

          # Busca el archivo .msi en la carpeta de build
          # El asterisco (*) asegura que coincida con cualquier versión
          file_glob: ./build/jpackage/*.msi

          # Lo asocia con el tag de la release actual
          tag: ${{ github.ref_name }}